<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾å¤¹å·¥å…· - æ–‡ä»¶éšå†™å®ç°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            background-color: #f8f0ff;
            color: #333;
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }
        
        .status-bar {
            background-color: #fff;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
            border-bottom: 1px solid #eee;
        }
        
        .status-left, .status-right {
            display: flex;
            align-items: center;
        }
        
        .status-right span {
            margin-left: 10px;
        }
        
        .header {
            background: linear-gradient(135deg, #6a5af9, #d66efd);
            color: white;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(106, 90, 249, 0.3);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px 15px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #6a5af9;
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 8px;
            font-size: 18px;
        }
        
        .upload-area {
            border: 2px dashed #d66efd;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .upload-area:hover {
            background-color: #f9f5ff;
            border-color: #6a5af9;
        }
        
        .upload-area i {
            font-size: 40px;
            color: #d66efd;
            margin-bottom: 10px;
        }
        
        .upload-text {
            font-size: 16px;
            color: #6a5af9;
            margin-bottom: 5px;
        }
        
        .upload-hint {
            font-size: 12px;
            color: #999;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 6px;
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            background-color: #d66efd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin-right: 10px;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .file-size {
            font-size: 12px;
            color: #999;
        }
        
        .remove-file {
            background: none;
            border: none;
            color: #ff4757;
            font-size: 18px;
            cursor: pointer;
        }
        
        .algorithm-select {
            display: flex;
            margin-bottom: 20px;
        }
        
        .algorithm-option {
            flex: 1;
            text-align: center;
            padding: 12px 5px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .algorithm-option:first-child {
            border-radius: 6px 0 0 6px;
            border-right: none;
        }
        
        .algorithm-option:last-child {
            border-radius: 0 6px 6px 0;
        }
        
        .algorithm-option.selected {
            background-color: #6a5af9;
            color: white;
            border-color: #6a5af9;
        }
        
        .algorithm-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .algorithm-desc {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .watermark-section {
            margin-bottom: 20px;
        }
        
        .watermark-label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: #666;
        }
        
        .watermark-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .action-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #6a5af9, #d66efd);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 90, 249, 0.4);
        }
        
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result-section {
            margin-top: 20px;
            display: none;
        }
        
        .result-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #6a5af9;
            display: flex;
            align-items: center;
        }
        
        .result-image {
            width: 100%;
            max-width: 200px;
            margin: 0 auto 15px;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .result-actions {
            display: flex;
            gap: 10px;
        }
        
        .result-btn {
            flex: 1;
            padding: 10px;
            background: #f1f1f1;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .result-btn.primary {
            background: #6a5af9;
            color: white;
        }
        
        .result-btn:hover {
            background: #e0e0e0;
        }
        
        .result-btn.primary:hover {
            background: #5a4ae9;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 12px;
        }
        
        .hidden {
            display: none;
        }
        
        .tab-container {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #6a5af9, #d66efd);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .status-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            display: block;
        }
    </style>
</head>
<body>
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-left">10:57</div>
        <div class="status-right">
            <span>4G</span>
            <span>38%</span>
        </div>
    </div>
    
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>å›¾å¤¹å·¥å…· - æ–‡ä»¶éšå†™å®ç°</h1>
        <p>å®‰å…¨éšè—æ–‡ä»¶åˆ°å›¾ç‰‡ä¸­</p>
    </div>
    
    <!-- æ ‡ç­¾é¡µ -->
    <div class="container">
        <div class="tab-container">
            <div class="tab" data-tab="unpack">å›¾ç‰‡è§£åŒ…</div>
            <div class="tab active" data-tab="pack">å›¾ç‰‡æ‰“åŒ…</div>
        </div>
        
        <!-- å›¾ç‰‡æ‰“åŒ…å†…å®¹ -->
        <div class="tab-content active" id="pack-tab">
            <!-- è¡¨å›¾é€‰æ‹© -->
            <div class="card">
                <div class="card-title">è¡¨å›¾é€‰æ‹©</div>
                <div class="upload-area" id="cover-upload">
                    <i>ğŸ“·</i>
                    <div class="upload-text">è‡ªå®šä¹‰ä¸Šä¼ </div>
                    <div class="upload-hint">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>
                </div>
                <div class="file-info hidden" id="cover-info">
                    <div class="file-icon">ğŸ–¼ï¸</div>
                    <div class="file-details">
                        <div class="file-name" id="cover-name">cover.jpg</div>
                        <div class="file-size" id="cover-size">2.1 MB</div>
                    </div>
                    <button class="remove-file" id="remove-cover">Ã—</button>
                </div>
            </div>
            
            <!-- é‡Œå›¾é€‰æ‹© -->
            <div class="card">
                <div class="card-title">é€‰æ‹©éšè—æ–‡ä»¶</div>
                <div class="upload-area" id="file-upload">
                    <i>ğŸ“</i>
                    <div class="upload-text">é€‰æ‹©éšè—æ–‡ä»¶</div>
                    <div class="upload-hint">ç‚¹å‡»é€‰æ‹©è¦éšè—çš„æ–‡ä»¶</div>
                </div>
                <div class="file-info hidden" id="file-info">
                    <div class="file-icon">ğŸ“„</div>
                    <div class="file-details">
                        <div class="file-name" id="file-name">secret.txt</div>
                        <div class="file-size" id="file-size">15 KB</div>
                    </div>
                    <button class="remove-file" id="remove-file">Ã—</button>
                </div>
            </div>
            
            <!-- ç®—æ³•é€‰æ‹© -->
            <div class="card">
                <div class="card-title">ç®—æ³•é€‰æ‹©</div>
                <div class="algorithm-select">
                    <div class="algorithm-option selected" data-algo="dynamic">
                        <div class="algorithm-name">LSBéšå†™ï¼ˆæ ‡å‡†ï¼‰</div>
                        <div class="algorithm-desc">æœ€ä½æœ‰æ•ˆä½éšå†™</div>
                    </div>
                    <div class="algorithm-option" data-algo="pro">
                        <div class="algorithm-name">LSBéšå†™ï¼ˆé«˜çº§ï¼‰</div>
                        <div class="algorithm-desc">éšæœºåƒç´ åˆ†å¸ƒ</div>
                    </div>
                </div>
                
                <!-- æ°´å°è®¾ç½® -->
                <div class="watermark-section">
                    <label class="watermark-label">å¯†ç :</label>
                    <input type="password" class="watermark-input" id="password" placeholder="è®¾ç½®å¯†ç ä¿æŠ¤ï¼ˆå¯é€‰ï¼‰">
                </div>
            </div>
            
            <!-- åˆ¶ä½œå›¾å¤¹æŒ‰é’® -->
            <button class="action-btn" id="create-btn">åˆ¶ä½œå›¾å¤¹</button>
            
            <!-- çŠ¶æ€æ¶ˆæ¯ -->
            <div class="status-message" id="pack-status"></div>
            
            <!-- æ‰“åŒ…ç»“æœ -->
            <div class="card result-section" id="result-section">
                <div class="result-title">æ‰“åŒ…ç»“æœ</div>
                
                <div class="result-actions">
                    <button class="result-btn" id="save-btn">ä¿å­˜å›¾ç‰‡</button>
                    <button class="result-btn primary" id="share-btn">åˆ†äº«</button>
                </div>
            </div>
        </div>
        
        <!-- å›¾ç‰‡è§£åŒ…å†…å®¹ -->
        <div class="tab-content" id="unpack-tab">
            <div class="card">
                <div class="card-title">é€‰æ‹©å›¾å¤¹å›¾ç‰‡</div>
                <div class="upload-area" id="stego-upload">
                    <i>ğŸ–¼ï¸</i>
                    <div class="upload-text">é€‰æ‹©å›¾å¤¹å›¾ç‰‡</div>
                    <div class="upload-hint">ç‚¹å‡»é€‰æ‹©åŒ…å«éšè—æ–‡ä»¶çš„å›¾ç‰‡</div>
                </div>
                <div class="file-info hidden" id="stego-info">
                    <div class="file-icon">ğŸ”</div>
                    <div class="file-details">
                        <div class="file-name" id="stego-name">stego.png</div>
                        <div class="file-size" id="stego-size">2.3 MB</div>
                    </div>
                    <button class="remove-file" id="remove-stego">Ã—</button>
                </div>
                
                <div class="watermark-section">
                    <label class="watermark-label">å¯†ç éªŒè¯:</label>
                    <input type="password" class="watermark-input" id="extract-password" placeholder="è¾“å…¥å¯†ç è¿›è¡ŒéªŒè¯ï¼ˆå¦‚å·²è®¾ç½®ï¼‰">
                </div>
                
                <button class="action-btn" id="extract-btn">æå–æ–‡ä»¶</button>
                
                <!-- çŠ¶æ€æ¶ˆæ¯ -->
                <div class="status-message" id="extract-status"></div>
                
                <div class="result-section hidden" id="extract-result">
                    <div class="result-title">æå–ç»“æœ</div>
                    <div class="file-info">
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-details">
                            <div class="file-name" id="extracted-name">secret.txt</div>
                            <div class="file-size" id="extracted-size">15 KB</div>
                        </div>
                    </div>
                    <div class="result-actions">
                        <button class="result-btn primary" id="download-btn">ä¸‹è½½æ–‡ä»¶</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„š -->
    <div class="footer">
        <p>å›¾å¤¹å·¥å…· v1.0 | åŸºäºLSBéšå†™ç®—æ³•</p>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="cover-input" accept="image/*" class="hidden">
    <input type="file" id="file-input" class="hidden">
    <input type="file" id="stego-input" accept="image/*" class="hidden">

    <script>
        // DOMå…ƒç´ 
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const coverUpload = document.getElementById('cover-upload');
        const fileUpload = document.getElementById('file-upload');
        const stegoUpload = document.getElementById('stego-upload');
        const coverInput = document.getElementById('cover-input');
        const fileInput = document.getElementById('file-input');
        const stegoInput = document.getElementById('stego-input');
        const coverInfo = document.getElementById('cover-info');
        const fileInfo = document.getElementById('file-info');
        const stegoInfo = document.getElementById('stego-info');
        const createBtn = document.getElementById('create-btn');
        const extractBtn = document.getElementById('extract-btn');
        const resultSection = document.getElementById('result-section');
        const extractResult = document.getElementById('extract-result');
        const algorithmOptions = document.querySelectorAll('.algorithm-option');
        const packStatus = document.getElementById('pack-status');
        const extractStatus = document.getElementById('extract-status');
        
        // å…¨å±€å˜é‡
        let selectedAlgorithm = 'dynamic';
        let coverFile = null;
        let secretFile = null;
        let stegoFile = null;
        let stegoImageCanvas = null;
        let extractedFile = null;
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // æ›´æ–°æ´»åŠ¨æ ‡ç­¾
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });
        
        // ç®—æ³•é€‰æ‹©
        algorithmOptions.forEach(option => {
            option.addEventListener('click', () => {
                algorithmOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                selectedAlgorithm = option.getAttribute('data-algo');
            });
        });
        
        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
        coverUpload.addEventListener('click', () => coverInput.click());
        fileUpload.addEventListener('click', () => fileInput.click());
        stegoUpload.addEventListener('click', () => stegoInput.click());
        
        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        coverInput.addEventListener('change', handleCoverSelect);
        fileInput.addEventListener('change', handleFileSelect);
        stegoInput.addEventListener('change', handleStegoSelect);
        
        // ç§»é™¤æ–‡ä»¶äº‹ä»¶
        document.getElementById('remove-cover').addEventListener('click', () => {
            coverInfo.classList.add('hidden');
            coverFile = null;
            coverInput.value = '';
            resultSection.style.display = 'none';
        });
        
        document.getElementById('remove-file').addEventListener('click', () => {
            fileInfo.classList.add('hidden');
            secretFile = null;
            fileInput.value = '';
            resultSection.style.display = 'none';
        });
        
        document.getElementById('remove-stego').addEventListener('click', () => {
            stegoInfo.classList.add('hidden');
            stegoFile = null;
            stegoInput.value = '';
            extractResult.classList.add('hidden');
            extractStatus.textContent = '';
            extractStatus.className = 'status-message';
        });
        
        // å¤„ç†å°é¢å›¾ç‰‡é€‰æ‹©
        function handleCoverSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showStatus(packStatus, 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            coverFile = file;
            document.getElementById('cover-name').textContent = file.name;
            document.getElementById('cover-size').textContent = formatFileSize(file.size);
            coverInfo.classList.remove('hidden');
            resultSection.style.display = 'none';
        }
        
        // å¤„ç†éšè—æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            secretFile = file;
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-size').textContent = formatFileSize(file.size);
            fileInfo.classList.remove('hidden');
            resultSection.style.display = 'none';
        }
        
        // å¤„ç†å›¾å¤¹å›¾ç‰‡é€‰æ‹©
        function handleStegoSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showStatus(extractStatus, 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            stegoFile = file;
            document.getElementById('stego-name').textContent = file.name;
            document.getElementById('stego-size').textContent = formatFileSize(file.size);
            stegoInfo.classList.remove('hidden');
            extractResult.classList.add('hidden');
            extractStatus.textContent = '';
            extractStatus.className = 'status-message';
        }
        
        // åˆ¶ä½œå›¾å¤¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        createBtn.addEventListener('click', async () => {
            if (!coverFile) {
                showStatus(packStatus, 'è¯·é€‰æ‹©å°é¢å›¾ç‰‡ï¼', 'error');
                return;
            }
            
            if (!secretFile) {
                showStatus(packStatus, 'è¯·é€‰æ‹©è¦éšè—çš„æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦é€‚åˆ
            const maxSize = await calculateMaxFileSize(coverFile);
            if (secretFile.size > maxSize) {
                showStatus(packStatus, `æ–‡ä»¶å¤ªå¤§ï¼æœ€å¤§æ”¯æŒ ${formatFileSize(maxSize)}`, 'error');
                return;
            }
            
            // å¤„ç†è¿‡ç¨‹
            createBtn.textContent = 'å¤„ç†ä¸­...';
            createBtn.disabled = true;
            packStatus.textContent = '';
            packStatus.className = 'status-message';
            
            try {
                // è¯»å–æ–‡ä»¶
                const coverImage = await loadImage(coverFile);
                const fileData = await readFileAsArrayBuffer(secretFile);
                
                // è·å–å¯†ç 
                const password = document.getElementById('password').value;
                
                // åŠ å¯†æ–‡ä»¶æ•°æ®ï¼ˆå¦‚æœæä¾›äº†å¯†ç ï¼‰
                let encryptedData = fileData;
                if (password) {
                    encryptedData = await simpleEncrypt(fileData, password);
                }
                
                // å°†æ–‡ä»¶æ•°æ®éšè—åˆ°å›¾åƒä¸­
                const stegoCanvas = await embedDataInImage(coverImage, encryptedData, secretFile.name, secretFile.type);
                
                // æ˜¾ç¤ºç»“æœ
                const resultImage = document.getElementById('result-image');
                resultImage.src = stegoCanvas.toDataURL();
                resultSection.style.display = 'block';
                stegoImageCanvas = stegoCanvas;
                
                showStatus(packStatus, 'æ–‡ä»¶éšè—æˆåŠŸï¼', 'success');
                
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                resultSection.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error(error);
                showStatus(packStatus, 'éšè—æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message, 'error');
            } finally {
                createBtn.textContent = 'åˆ¶ä½œå›¾å¤¹';
                createBtn.disabled = false;
            }
        });
        
        // æå–æ–‡ä»¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        extractBtn.addEventListener('click', async () => {
            if (!stegoFile) {
                showStatus(extractStatus, 'è¯·é€‰æ‹©å›¾å¤¹å›¾ç‰‡ï¼', 'error');
                return;
            }
            
            // å¤„ç†è¿‡ç¨‹
            extractBtn.textContent = 'æå–ä¸­...';
            extractBtn.disabled = true;
            extractStatus.textContent = '';
            extractStatus.className = 'status-message';
            
            try {
                // åŠ è½½å›¾ç‰‡
                const stegoImage = await loadImage(stegoFile);
                
                // ä»å›¾åƒä¸­æå–æ•°æ®
                const extracted = await extractDataFromImage(stegoImage);
                
                if (!extracted) {
                    showStatus(extractStatus, 'æœªæ‰¾åˆ°éšè—æ–‡ä»¶æˆ–æ–‡ä»¶å·²æŸå', 'error');
                    return;
                }
                
                // è·å–å¯†ç 
                const password = document.getElementById('extract-password').value;
                
                // è§£å¯†æ•°æ®ï¼ˆå¦‚æœæä¾›äº†å¯†ç ï¼‰
                let decryptedData = extracted.data;
                if (password) {
                    try {
                        decryptedData = await simpleDecrypt(decryptedData, password);
                    } catch (e) {
                        showStatus(extractStatus, 'å¯†ç é”™è¯¯æˆ–æ–‡ä»¶æŸå', 'error');
                        return;
                    }
                }
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([decryptedData], { type: extracted.type });
                extractedFile = {
                    blob: blob,
                    name: extracted.name,
                    type: extracted.type
                };
                
                // æ˜¾ç¤ºæå–ç»“æœ
                document.getElementById('extracted-name').textContent = extracted.name;
                document.getElementById('extracted-size').textContent = formatFileSize(blob.size);
                extractResult.classList.remove('hidden');
                
                showStatus(extractStatus, `æˆåŠŸæå–æ–‡ä»¶: ${extracted.name}`, 'success');
                
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                extractResult.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error(error);
                showStatus(extractStatus, 'æå–æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message, 'error');
            } finally {
                extractBtn.textContent = 'æå–æ–‡ä»¶';
                extractBtn.disabled = false;
            }
        });
        
        // ä¿å­˜å›¾ç‰‡æŒ‰é’®
        document.getElementById('save-btn').addEventListener('click', () => {
            if (!stegoImageCanvas) return;
            
            const link = document.createElement('a');
            link.download = 'stego_image.png';
            link.href = stegoImageCanvas.toDataURL();
            link.click();
        });
        
        // åˆ†äº«æŒ‰é’®
        document.getElementById('share-btn').addEventListener('click', () => {
            alert('åˆ†äº«åŠŸèƒ½éœ€è¦åœ¨å®é™…åº”ç”¨ä¸­å®ç°ï¼');
        });
        
        // ä¸‹è½½æ–‡ä»¶æŒ‰é’®
        document.getElementById('download-btn').addEventListener('click', () => {
            if (!extractedFile) return;
            
            const link = document.createElement('a');
            link.download = extractedFile.name;
            link.href = URL.createObjectURL(extractedFile.blob);
            link.click();
            URL.revokeObjectURL(link.href);
        });
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = 'status-message ' + type;
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // åŠ è½½å›¾ç‰‡
       
        // åŠ è½½å›¾ç‰‡
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }
        
        // è¯»å–æ–‡ä»¶ä¸ºArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // è®¡ç®—å›¾ç‰‡æœ€å¤§å¯éšè—æ–‡ä»¶å¤§å°
        function calculateMaxFileSize(imageFile) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    // æ¯ä¸ªåƒç´ å¯ä»¥éšè—3ä½æ•°æ®ï¼ˆRGBå„1ä½ï¼‰
                    const maxBits = img.width * img.height * 3;
                    // å‡å»æ–‡ä»¶å¤´ä¿¡æ¯ï¼ˆæ–‡ä»¶åã€ç±»å‹ç­‰ï¼‰
                    const maxFileSize = Math.floor(maxBits / 8) - 100;
                    resolve(maxFileSize);
                };
                img.src = URL.createObjectURL(imageFile);
            });
        }
        
        // ç®€å•çš„åŠ å¯†å‡½æ•°ï¼ˆXORï¼‰
        function simpleEncrypt(data, password) {
            return new Promise((resolve) => {
                const dataArray = new Uint8Array(data);
                const passwordArray = new TextEncoder().encode(password);
                const result = new Uint8Array(dataArray.length);
                
                for (let i = 0; i < dataArray.length; i++) {
                    result[i] = dataArray[i] ^ passwordArray[i % passwordArray.length];
                }
                
                resolve(result);
            });
        }
        
        // ç®€å•çš„è§£å¯†å‡½æ•°ï¼ˆXORï¼‰
        function simpleDecrypt(data, password) {
            // XORåŠ å¯†å’Œè§£å¯†æ˜¯ç›¸åŒçš„æ“ä½œ
            return simpleEncrypt(data, password);
        }
        
        // å°†æ•°æ®åµŒå…¥åˆ°å›¾åƒä¸­ï¼ˆLSBéšå†™ï¼‰
        function embedDataInImage(image, fileData, fileName, fileType) {
            return new Promise((resolve) => {
                // åˆ›å»ºCanvas
                const canvas = document.createElement('canvas');
                canvas.width = image.width;
                canvas.height = image.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0);
                
                // è·å–å›¾åƒæ•°æ®
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // æ–‡ä»¶å¤´ä¿¡æ¯ï¼šæ–‡ä»¶åé•¿åº¦(1å­—èŠ‚) + æ–‡ä»¶å + æ–‡ä»¶ç±»å‹é•¿åº¦(1å­—èŠ‚) + æ–‡ä»¶ç±»å‹ + æ–‡ä»¶æ•°æ®é•¿åº¦(4å­—èŠ‚) + æ–‡ä»¶æ•°æ®
                const fileNameBytes = new TextEncoder().encode(fileName);
                const fileTypeBytes = new TextEncoder().encode(fileType);
                
                // è®¡ç®—æ€»æ•°æ®é•¿åº¦
                const totalLength = 1 + fileNameBytes.length + 1 + fileTypeBytes.length + 4 + fileData.length;
                
                // æ£€æŸ¥å›¾åƒå®¹é‡æ˜¯å¦è¶³å¤Ÿ
                if (totalLength * 8 > data.length) {
                    throw new Error('å›¾åƒå®¹é‡ä¸è¶³ï¼Œæ— æ³•éšè—è¯¥æ–‡ä»¶');
                }
                
                // å°†æ–‡ä»¶æ•°æ®è½¬æ¢ä¸ºäºŒè¿›åˆ¶ä½
                const bits = [];
                
                // æ·»åŠ æ–‡ä»¶åé•¿åº¦
                addByteToBits(bits, fileNameBytes.length);
                
                // æ·»åŠ æ–‡ä»¶å
                for (let i = 0; i < fileNameBytes.length; i++) {
                    addByteToBits(bits, fileNameBytes[i]);
                }
                
                // æ·»åŠ æ–‡ä»¶ç±»å‹é•¿åº¦
                addByteToBits(bits, fileTypeBytes.length);
                
                // æ·»åŠ æ–‡ä»¶ç±»å‹
                for (let i = 0; i < fileTypeBytes.length; i++) {
                    addByteToBits(bits, fileTypeBytes[i]);
                }
                
                // æ·»åŠ æ–‡ä»¶æ•°æ®é•¿åº¦
                addIntToBits(bits, fileData.length);
                
                // æ·»åŠ æ–‡ä»¶æ•°æ®
                for (let i = 0; i < fileData.length; i++) {
                    addByteToBits(bits, fileData[i]);
                }
                
                // å°†äºŒè¿›åˆ¶ä½åµŒå…¥åˆ°å›¾åƒæ•°æ®ä¸­
                let bitIndex = 0;
                for (let i = 0; i < data.length && bitIndex < bits.length; i++) {
                    // è·³è¿‡Alphaé€šé“
                    if ((i + 1) % 4 === 0) continue;
                    
                    // æ›¿æ¢æœ€ä½æœ‰æ•ˆä½
                    data[i] = (data[i] & 0xFE) | bits[bitIndex];
                    bitIndex++;
                }
                
                // æ›´æ–°Canvas
                ctx.putImageData(imageData, 0, 0);
                
                resolve(canvas);
            });
        }
        
        // ä»å›¾åƒä¸­æå–æ•°æ®
        function extractDataFromImage(image) {
            return new Promise((resolve) => {
                // åˆ›å»ºCanvas
                const canvas = document.createElement('canvas');
                canvas.width = image.width;
                canvas.height = image.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0);
                
                // è·å–å›¾åƒæ•°æ®
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // æå–äºŒè¿›åˆ¶ä½
                const bits = [];
                for (let i = 0; i < data.length; i++) {
                    // è·³è¿‡Alphaé€šé“
                    if ((i + 1) % 4 === 0) continue;
                    
                    // æå–æœ€ä½æœ‰æ•ˆä½
                    bits.push(data[i] & 1);
                }
                
                let bitIndex = 0;
                
                // æå–æ–‡ä»¶åé•¿åº¦
                const fileNameLength = extractByteFromBits(bits, bitIndex);
                bitIndex += 8;
                
                // æå–æ–‡ä»¶å
                const fileNameBytes = new Uint8Array(fileNameLength);
                for (let i = 0; i < fileNameLength; i++) {
                    fileNameBytes[i] = extractByteFromBits(bits, bitIndex);
                    bitIndex += 8;
                }
                const fileName = new TextDecoder().decode(fileNameBytes);
                
                // æå–æ–‡ä»¶ç±»å‹é•¿åº¦
                const fileTypeLength = extractByteFromBits(bits, bitIndex);
                bitIndex += 8;
                
                // æå–æ–‡ä»¶ç±»å‹
                const fileTypeBytes = new Uint8Array(fileTypeLength);
                for (let i = 0; i < fileTypeLength; i++) {
                    fileTypeBytes[i] = extractByteFromBits(bits, bitIndex);
                    bitIndex += 8;
                }
                const fileType = new TextDecoder().decode(fileTypeBytes);
                
                // æå–æ–‡ä»¶æ•°æ®é•¿åº¦
                const fileSize = extractIntFromBits(bits, bitIndex);
                bitIndex += 32;
                
                // æå–æ–‡ä»¶æ•°æ®
                const fileData = new Uint8Array(fileSize);
                for (let i = 0; i < fileSize; i++) {
                    fileData[i] = extractByteFromBits(bits, bitIndex);
                    bitIndex += 8;
                }
                
                resolve({
                    name: fileName,
                    type: fileType,
                    data: fileData
                });
            });
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå°†å­—èŠ‚æ·»åŠ åˆ°äºŒè¿›åˆ¶ä½æ•°ç»„
        function addByteToBits(bits, byte) {
            for (let i = 7; i >= 0; i--) {
                bits.push((byte >> i) & 1);
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå°†æ•´æ•°æ·»åŠ åˆ°äºŒè¿›åˆ¶ä½æ•°ç»„
        function addIntToBits(bits, int) {
            for (let i = 24; i >= 0; i -= 8) {
                addByteToBits(bits, (int >> i) & 0xFF);
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šä»äºŒè¿›åˆ¶ä½æ•°ç»„ä¸­æå–å­—èŠ‚
        function extractByteFromBits(bits, startIndex) {
            let byte = 0;
            for (let i = 0; i < 8; i++) {
                byte = (byte << 1) | bits[startIndex + i];
            }
            return byte;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šä»äºŒè¿›åˆ¶ä½æ•°ç»„ä¸­æå–æ•´æ•°
        function extractIntFromBits(bits, startIndex) {
            let int = 0;
            for (let i = 0; i < 4; i++) {
                int = (int << 8) | extractByteFromBits(bits, startIndex + i * 8);
            }
            return int;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            // æ·»åŠ ç»“æœå›¾ç‰‡é¢„è§ˆ
            const resultSection = document.getElementById('result-section');
            const resultImage = document.createElement('img');
            resultImage.id = 'result-image';
            resultImage.className = 'result-image';
            resultSection.insertBefore(resultImage, resultSection.querySelector('.result-actions'));
        });
    </script>
</body>
</html>
